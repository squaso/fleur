<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>Fleur d'Amour â€” FlorerÃ­a en Charlotte</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        "m3-primary": "#904A4C",
        "m3-on-primary": "#FFFFFF",
        "m3-primary-container": "#FFDAD7",
        "m3-on-primary-container": "#3B080E",
        "m3-surface": "#FFF8F7",
        "m3-surface-variant": "#F4DDDD",
        "m3-on-surface": "#221919",
        "m3-on-surface-variant": "#534342",
        "m3-outline": "#857371",
        "m3-surface-container-lowest": "#FFFFFF",
        "m3-surface-container-low": "#FEF1F0",
        "m3-surface-container": "#FCEAE9",
        "m3-surface-container-high": "#F6E4E3",
        "m3-surface-container-highest": "#F1DFDE",
      },
      fontFamily: {
        "display": ["Plus Jakarta Sans", "sans-serif"]
      },
      boxShadow: {
        'm3-elevation-1': '0px 1px 3px 1px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.30)',
        'm3-elevation-2': '0px 2px 6px 2px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.30)',
        'm3-elevation-3': '0px 1px 3px 0px rgba(0, 0, 0, 0.30), 0px 4px 8px 3px rgba(0, 0, 0, 0.15)',
        'm3-nav-pill': '0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px 0px rgba(0, 0, 0, 0.30)',
      }
    },
  },
}
</script>
<style>
body { min-height: 100dvh; background-color: #FFF8F7; -webkit-tap-highlight-color: transparent;}
.hide-scrollbar::-webkit-scrollbar { display: none; }
.hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
.fade-in { animation: fadeIn 0.4s cubic-bezier(0.2, 0, 0, 1); }
@keyframes fadeIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
.slide-up-full { animation: slideUpFull 0.4s cubic-bezier(0.2, 0, 0, 1) forwards; }
@keyframes slideUpFull { from { transform: translateY(100%); opacity: 0.5; } to { transform: translateY(0); opacity: 1; } }
.slide-down-full { animation: slideDownFull 0.3s cubic-bezier(0.2, 0, 0, 1) forwards; }
@keyframes slideDownFull { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }
.pb-safe { padding-bottom: env(safe-area-inset-bottom); }
</style>
</head>
<body class="font-display min-h-screen text-m3-on-surface antialiased">

<div id="app">
  <!-- HEADER -->
  <header class="sticky top-0 z-40 bg-m3-surface pt-6 pb-2 px-4 transition-all duration-300" id="main-header">
    <div class="max-w-lg mx-auto w-full">
      <div class="flex justify-between items-center mb-5">
        <img src="logo.png" alt="Fleur d'Amour" class="h-10 object-contain"/>
        <a href="https://instagram.com" target="_blank" class="w-10 h-10 rounded-full bg-m3-primary-container text-m3-on-primary-container flex items-center justify-center transition-transform active:scale-95">
          <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
        </a>
      </div>
      
      <div class="relative w-full h-14 bg-m3-surface-container-high rounded-full flex items-center px-2 transition-all shadow-sm focus-within:bg-m3-surface-container-highest focus-within:shadow-m3-elevation-1">
        <div class="w-10 h-full flex items-center justify-center shrink-0">
          <span class="material-icons-round text-m3-on-surface-variant">search</span>
        </div>
        <input id="search-input" oninput="filterProducts()" onfocus="navigateTo('browse')" class="flex-1 bg-transparent border-none h-full text-[15px] text-m3-on-surface placeholder-m3-on-surface-variant font-medium focus:ring-0 px-0" placeholder="Buscar rosas, regalos..." type="text"/>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="max-w-lg mx-auto w-full px-4 pt-4 pb-32">
    
    <!-- HOME & BROWSE VIEW -->
    <div id="home-view">
      <section id="categories-section" class="mb-8">
        <div id="categories-bar" class="flex space-x-2 overflow-x-auto hide-scrollbar pb-1"></div>
      </section>

      <section id="banner-section" class="mb-8">
        <div id="banner-container"></div>
      </section>

      <section>
        <div class="flex justify-between items-end mb-5 px-1">
          <h2 id="section-title" class="text-2xl font-bold tracking-tight text-m3-on-surface">Para ti</h2>
        </div>
        
        <div id="products-grid" class="grid grid-cols-2 gap-3 sm:gap-4"></div>
        
        <div id="no-products" class="hidden text-center py-20 text-m3-outline">
          <div class="w-20 h-20 bg-m3-surface-variant rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="material-icons-round text-4xl text-m3-outline-variant">search_off</span>
          </div>
          <p class="font-bold text-lg text-m3-on-surface-variant">Sin resultados</p>
        </div>
        
        <div id="loading-skeleton" class="grid grid-cols-2 gap-4">
          <div class="bg-m3-surface-container rounded-[24px] overflow-hidden animate-pulse"><div class="aspect-[4/5] bg-m3-surface-variant"></div><div class="p-4"><div class="h-4 bg-m3-surface-variant rounded-full w-3/4 mb-3"></div><div class="h-5 bg-m3-surface-variant rounded-full w-1/2"></div></div></div>
          <div class="bg-m3-surface-container rounded-[24px] overflow-hidden animate-pulse"><div class="aspect-[4/5] bg-m3-surface-variant"></div><div class="p-4"><div class="h-4 bg-m3-surface-variant rounded-full w-3/4 mb-3"></div><div class="h-5 bg-m3-surface-variant rounded-full w-1/2"></div></div></div>
        </div>
      </section>
    </div>

    <!-- PROFILE VIEW -->
    <div id="profile-view" class="hidden fade-in">
      
      <!-- Unauthenticated: Login/Register -->
      <div id="auth-container" class="max-w-sm mx-auto pt-4">
        <div class="text-center mb-8">
          <div class="w-20 h-20 bg-m3-primary-container text-m3-on-primary-container rounded-full flex items-center justify-center mx-auto mb-4 transform -rotate-6">
            <span class="material-icons-round text-4xl">local_florist</span>
          </div>
          <h2 class="text-2xl font-bold text-m3-on-surface">Bienvenido</h2>
          <p class="text-m3-on-surface-variant text-sm mt-1">Inicia sesiÃ³n para ver tus pedidos</p>
        </div>

        <div class="bg-m3-surface-container-low rounded-[28px] p-6 shadow-sm border border-m3-surface-container-high">
          <div class="space-y-4">
            <div>
              <label class="block text-[11px] font-bold uppercase tracking-wider text-m3-outline mb-1.5 ml-1">Email</label>
              <input id="auth-email" type="email" class="w-full bg-m3-surface-container-lowest border-2 border-m3-surface-container-highest focus:border-m3-primary rounded-[16px] px-4 py-3.5 text-sm focus:ring-0 transition-colors" placeholder="tu@email.com"/>
            </div>
            <div>
              <label class="block text-[11px] font-bold uppercase tracking-wider text-m3-outline mb-1.5 ml-1">ContraseÃ±a</label>
              <input id="auth-password" type="password" class="w-full bg-m3-surface-container-lowest border-2 border-m3-surface-container-highest focus:border-m3-primary rounded-[16px] px-4 py-3.5 text-sm focus:ring-0 transition-colors" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
            </div>
            
            <button onclick="handleAuth()" id="btn-auth" class="w-full bg-m3-primary text-m3-on-primary font-bold py-4 rounded-full shadow-m3-elevation-1 active:scale-[0.98] transition-all mt-2">
              Iniciar SesiÃ³n
            </button>
          </div>

          <div class="mt-6 text-center">
            <button onclick="toggleAuthMode()" id="btn-auth-toggle" class="text-sm font-semibold text-m3-primary hover:underline">
              Â¿No tienes cuenta? RegÃ­strate
            </button>
          </div>
        </div>
      </div>

      <!-- Authenticated: User Profile -->
      <div id="user-profile" class="hidden">
        <div class="flex items-center justify-between mb-8">
          <div>
            <h2 class="text-3xl font-bold tracking-tight text-m3-on-surface">Mi Perfil</h2>
            <p id="user-email-display" class="text-sm text-m3-on-surface-variant font-medium mt-1">cargando...</p>
          </div>
          <button onclick="handleLogout()" class="w-10 h-10 rounded-full bg-m3-surface-container-high text-m3-on-surface-variant hover:bg-[#FFDAD6] hover:text-[#410002] flex items-center justify-center transition-colors">
            <span class="material-icons-round text-xl">logout</span>
          </button>
        </div>

        <div class="mb-6">
          <h3 class="text-lg font-bold text-m3-on-surface mb-4 px-1">Mis Pedidos Recientes</h3>
          <div id="orders-list" class="space-y-4">
            <!-- Orders injected here -->
          </div>
          <div id="no-orders" class="hidden text-center py-10 bg-m3-surface-container-low rounded-[24px] border border-dashed border-m3-outline-variant">
            <p class="text-m3-on-surface-variant font-medium">AÃºn no tienes pedidos</p>
            <button onclick="navigateTo('home')" class="mt-2 text-sm font-bold text-m3-primary">Explorar tienda</button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- Navigation -->
  <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 z-40 w-auto">
    <div class="bg-m3-surface-container/90 backdrop-blur-md shadow-m3-nav-pill rounded-full px-6 py-2.5 flex items-center gap-6">
      <button onclick="navigateTo('home')" class="nav-btn group relative flex items-center justify-center" data-target="home">
        <div class="w-11 h-11 rounded-full flex items-center justify-center transition-colors bg-m3-primary-container text-m3-on-primary-container nav-pill">
          <span class="material-icons-round text-[24px]">storefront</span>
        </div>
      </button>
      <button onclick="navigateTo('browse')" class="nav-btn group relative flex items-center justify-center" data-target="browse">
        <div class="w-11 h-11 rounded-full flex items-center justify-center transition-colors text-m3-on-surface-variant nav-pill">
          <span class="material-icons-round text-[24px]">search</span>
        </div>
      </button>
      <button onclick="showCart()" class="nav-btn group relative flex items-center justify-center" data-target="cart">
        <div class="w-11 h-11 rounded-full flex items-center justify-center transition-colors text-m3-on-surface-variant relative nav-pill">
          <span class="material-icons-round text-[24px]">shopping_cart</span>
          <span id="cart-badge-nav" class="hidden absolute top-0 right-0 h-4 w-4 bg-m3-primary text-m3-on-primary text-[10px] font-bold flex items-center justify-center rounded-full border-2 border-m3-surface-container transform translate-x-1/4 -translate-y-1/4">0</span>
        </div>
      </button>
      <button onclick="navigateTo('profile')" class="nav-btn group relative flex items-center justify-center" data-target="profile">
        <div class="w-11 h-11 rounded-full flex items-center justify-center transition-colors text-m3-on-surface-variant nav-pill">
          <span class="material-icons-round text-[24px]">person</span>
        </div>
      </button>
    </div>
  </nav>
</div>

<!-- PRODUCT DETAIL MODAL -->
<div id="product-modal" class="fixed inset-0 z-50 hidden bg-m3-surface overflow-hidden flex flex-col">
  <div id="product-modal-content" class="flex-1 overflow-y-auto w-full max-w-lg mx-auto hide-scrollbar pb-32"></div>
</div>

<!-- CART MODAL -->
<div id="cart-modal" class="fixed inset-0 z-50 hidden bg-m3-surface overflow-hidden flex flex-col">
  <div class="max-w-lg mx-auto w-full h-full flex flex-col relative">
    <div class="px-4 py-4 flex items-center justify-between sticky top-0 z-10 bg-m3-surface/90 backdrop-blur-md">
      <button onclick="closeCart()" class="w-12 h-12 flex items-center justify-center rounded-full hover:bg-m3-surface-variant transition-colors text-m3-on-surface">
        <span class="material-icons-round text-2xl">close</span>
      </button>
      <h2 class="text-xl font-bold text-m3-on-surface tracking-tight">Tu Carrito</h2>
      <div class="w-12"></div>
    </div>
    <div id="cart-content" class="flex-1 overflow-y-auto px-4 pb-40 hide-scrollbar"></div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://kihsjtpzevgtqpckgeux.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpaHNqdHB6ZXZndHFwY2tnZXV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MjEwMDksImV4cCI6MjA4NjQ5NzAwOX0.63iuNCkhfazNnjW_xWHQG_70YBsiewytcL0dzBvUFDc";
const PHONE_NUMBER = "17049079361"; 

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let allProducts = [];
let allSections = [];
let cart = JSON.parse(localStorage.getItem('fleur-cart') || '[]');
let activeCategory = 'all';
let currentUser = null;
let isLoginMode = true;

// Expose to global
window.addToCart = addToCart;
window.addFromModal = addFromModal;
window.removeFromCart = removeFromCart;
window.updateCartQty = updateCartQty;
window.showCart = showCart;
window.closeCart = closeCart;
window.showProductDetail = showProductDetail;
window.closeProductModal = closeProductModal;
window.filterByCategory = filterByCategory;
window.filterProducts = filterProducts;
window.navigateTo = navigateTo;
window.processOrder = processOrder;
window.showToast = showToast;
window.handleAuth = handleAuth;
window.toggleAuthMode = toggleAuthMode;
window.handleLogout = handleLogout;

// â”€â”€ Auth Logic â”€â”€
async function initAuth() {
  const { data: { session } } = await supabase.auth.getSession();
  updateAuthUI(session);

  supabase.auth.onAuthStateChange((_event, session) => {
    updateAuthUI(session);
  });
}

function updateAuthUI(session) {
  currentUser = session?.user || null;
  const authContainer = document.getElementById('auth-container');
  const userProfile = document.getElementById('user-profile');
  
  if (currentUser) {
    authContainer.classList.add('hidden');
    userProfile.classList.remove('hidden');
    document.getElementById('user-email-display').textContent = currentUser.email;
    loadUserOrders();
  } else {
    authContainer.classList.remove('hidden');
    userProfile.classList.add('hidden');
  }
}

async function handleAuth() {
  const email = document.getElementById('auth-email').value;
  const password = document.getElementById('auth-password').value;
  const btn = document.getElementById('btn-auth');
  
  if (!email || !password) { showToast('Rellena todos los campos'); return; }

  btn.disabled = true;
  btn.textContent = 'Procesando...';

  try {
    if (isLoginMode) {
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;
    } else {
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) throw error;
      showToast('Â¡Registro exitoso! Iniciando sesiÃ³n...');
    }
  } catch (e) {
    showToast(e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = isLoginMode ? 'Iniciar SesiÃ³n' : 'Registrarse';
  }
}

function toggleAuthMode() {
  isLoginMode = !isLoginMode;
  document.getElementById('btn-auth').textContent = isLoginMode ? 'Iniciar SesiÃ³n' : 'Registrarse';
  document.getElementById('btn-auth-toggle').textContent = isLoginMode ? 'Â¿No tienes cuenta? RegÃ­strate' : 'Â¿Ya tienes cuenta? Inicia SesiÃ³n';
}

async function handleLogout() {
  await supabase.auth.signOut();
  showToast('SesiÃ³n cerrada');
}

async function loadUserOrders() {
  if (!currentUser) return;
  const list = document.getElementById('orders-list');
  const empty = document.getElementById('no-orders');
  
  list.innerHTML = '<div class="text-center py-4 text-sm text-m3-outline">Cargando pedidos...</div>';

  const { data: orders, error } = await supabase
    .from('orders')
    .select('*')
    .eq('user_id', currentUser.id)
    .order('created_at', { ascending: false });

  if (error || !orders || orders.length === 0) {
    list.innerHTML = '';
    empty.classList.remove('hidden');
    return;
  }

  empty.classList.add('hidden');
  list.innerHTML = orders.map(o => {
    const date = new Date(o.created_at).toLocaleDateString();
    let statusColor = 'bg-gray-100 text-gray-600';
    if(o.status === 'pendiente') statusColor = 'bg-yellow-100 text-yellow-800';
    if(o.status === 'en camino') statusColor = 'bg-blue-100 text-blue-800';
    if(o.status === 'entregado') statusColor = 'bg-green-100 text-green-800';

    return `
      <div class="bg-m3-surface-container rounded-[20px] p-4 border border-m3-surface-container-high">
        <div class="flex justify-between items-start mb-2">
          <div>
            <span class="text-xs font-bold text-m3-outline uppercase tracking-wider">Pedido #${o.id}</span>
            <p class="text-xs text-m3-on-surface-variant">${date}</p>
          </div>
          <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${statusColor}">${o.status}</span>
        </div>
        <div class="text-sm font-medium text-m3-on-surface mb-2">
          ${o.items.length} artÃ­culo(s) â€¢ ${o.customer_address}
        </div>
        <div class="flex justify-between items-end border-t border-m3-outline/10 pt-2">
          <span class="text-xs text-m3-on-surface-variant">Total</span>
          <span class="text-lg font-bold text-m3-primary">$${o.total_amount.toFixed(2)}</span>
        </div>
      </div>
    `;
  }).join('');
}

// â”€â”€ App Logic â”€â”€
async function loadData() {
  try {
    const { data: sectionsData } = await supabase.from('sections').select('*').order('order', { ascending: true });
    allSections = sectionsData || [];
    const { data: productsData } = await supabase.from('products').select('*').order('order', { ascending: true });
    allProducts = productsData || [];

    document.getElementById('loading-skeleton').classList.add('hidden');
    renderCategories();
    renderBanner();
    renderProducts();
    updateCartUI();
    initAuth(); // Inicializar Auth
  } catch (e) {
    console.error('Error loading data:', e);
  }
}

function renderCategories() {
  const bar = document.getElementById('categories-bar');
  let html = `<button onclick="filterByCategory('all')" class="flex-shrink-0 border transition-all ${activeCategory === 'all' ? 'bg-m3-on-surface text-m3-surface border-m3-on-surface shadow-md' : 'bg-transparent text-m3-on-surface border-m3-outline hover:bg-m3-surface-variant'} px-5 py-2.5 rounded-[12px] text-sm font-bold whitespace-nowrap">Todos</button>`;
  allSections.forEach(s => {
    const isActive = activeCategory === s.id;
    html += `<button onclick="filterByCategory('${s.id}')" class="flex-shrink-0 border transition-all ${isActive ? 'bg-m3-on-surface text-m3-surface border-m3-on-surface shadow-md' : 'bg-transparent text-m3-on-surface border-m3-outline hover:bg-m3-surface-variant'} px-5 py-2.5 rounded-[12px] text-sm font-bold whitespace-nowrap">${s.emoji || ''} ${s.name}</button>`;
  });
  bar.innerHTML = html;
}

function renderBanner() {
  const container = document.getElementById('banner-container');
  const featured = allSections.find(s => s.featured) || allSections.find(s => s.bannerImage) || allSections[0];
  if (!featured || !featured.bannerImage) { container.innerHTML = ''; return; }
  container.innerHTML = `
    <div onclick="filterByCategory('${featured.id}')" class="relative w-full aspect-[2/1] rounded-[28px] overflow-hidden group cursor-pointer">
      <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent z-10"></div>
      <img alt="${featured.name}" class="w-full h-full object-cover transform transition-transform duration-700 group-hover:scale-105" src="${featured.bannerImage}"/>
      <div class="absolute bottom-0 left-0 p-6 z-20">
        ${featured.badge ? `<span class="bg-m3-primary-container text-m3-on-primary-container text-xs font-extrabold px-3 py-1 rounded-full mb-3 inline-block uppercase tracking-wider">${featured.badge}</span>` : ''}
        <h3 class="text-white text-3xl font-extrabold leading-none tracking-tight">${featured.name}</h3>
        ${featured.subtitle ? `<p class="text-white/90 text-sm mt-2 font-medium">${featured.subtitle}</p>` : ''}
      </div>
    </div>`;
}

function renderProducts() {
  const grid = document.getElementById('products-grid');
  const noProducts = document.getElementById('no-products');
  const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
  let filtered = allProducts;
  if (activeCategory !== 'all') filtered = filtered.filter(p => p.sectionId === activeCategory);
  if (searchTerm) filtered = filtered.filter(p => (p.name || '').toLowerCase().includes(searchTerm));
  if (filtered.length === 0) { grid.innerHTML = ''; noProducts.classList.remove('hidden'); return; }
  noProducts.classList.add('hidden');
  grid.innerHTML = filtered.map((p, i) => `
    <div onclick="showProductDetail('${p.id}')" class="bg-m3-surface-container-lowest border border-m3-surface-container-highest rounded-[28px] p-2.5 flex flex-col h-full cursor-pointer hover:shadow-m3-elevation-1 transition-all fade-in" style="animation-delay: ${i * 40}ms">
      <div class="relative aspect-[4/5] rounded-[20px] overflow-hidden bg-m3-surface-container mb-3">
        <img alt="${p.name}" class="w-full h-full object-cover" src="${p.images ? p.images[0] : (p.image || '')}" loading="lazy"/>
      </div>
      <div class="px-2 pb-1 flex flex-col flex-grow">
        <h3 class="text-sm font-bold text-m3-on-surface leading-tight mb-1 line-clamp-2">${p.name}</h3>
        <div class="mt-auto pt-2 flex items-end justify-between">
          <span class="text-lg font-extrabold text-m3-on-surface leading-none">$${p.price.toFixed(2)}</span>
          <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="w-10 h-10 rounded-[12px] bg-m3-primary-container text-m3-on-primary-container flex items-center justify-center transition-colors shrink-0">
            <span class="material-icons-round text-xl">add</span>
          </button>
        </div>
      </div>
    </div>`).join('');
}

function showProductDetail(productId) {
  const p = allProducts.find(x => x.id === productId);
  if (!p) return;
  const section = allSections.find(s => s.id === p.sectionId);
  const images = p.images || [p.image || ''];
  const modal = document.getElementById('product-modal');
  const content = document.getElementById('product-modal-content');
  modal.classList.remove('hidden', 'slide-down-full');
  modal.classList.add('slide-up-full');
  content.innerHTML = `
    <div class="sticky top-0 z-20 bg-m3-surface/80 backdrop-blur-lg px-4 py-4 flex items-center justify-between">
       <button onclick="closeProductModal()" class="w-12 h-12 bg-m3-surface-container-high rounded-full flex items-center justify-center text-m3-on-surface"><span class="material-icons-round">arrow_back</span></button>
    </div>
    <div class="relative w-full aspect-[4/5] -mt-20">
      <img id="detail-main-img" alt="${p.name}" class="w-full h-full object-cover rounded-b-[40px] shadow-sm" src="${images[0]}"/>
    </div>
    <div class="px-6 pt-8 pb-40">
      <h1 class="text-3xl font-extrabold text-m3-on-surface leading-tight">${p.name}</h1>
      <span class="text-3xl font-extrabold text-m3-primary block mt-2">$${p.price.toFixed(2)}</span>
      <p class="text-m3-on-surface-variant mt-4 text-[15px] font-medium leading-relaxed">${p.description || ''}</p>
      ${p.options && p.options.length > 0 ? `<div class="mt-8">
        <h3 class="text-sm font-bold text-m3-on-surface mb-3 uppercase tracking-wider">Opciones</h3>
        <div class="grid grid-cols-1 gap-3">
          ${p.options.map((opt, i) => `
            <label class="relative cursor-pointer">
              <input ${i === 0 ? 'checked' : ''} class="peer sr-only" name="product-option" type="radio" value="${opt.name}" onchange="updateDetailPrice('${p.id}', ${opt.extraPrice || 0})"/>
              <div class="p-4 rounded-[16px] border-2 border-m3-surface-container-highest bg-m3-surface-container-lowest peer-checked:border-m3-primary peer-checked:bg-m3-primary-container transition-all flex justify-between items-center">
                <span class="font-bold text-m3-on-surface">${opt.name}</span>
                <span class="text-sm font-extrabold text-m3-primary">${opt.extraPrice ? `+$${opt.extraPrice.toFixed(2)}` : 'Incluido'}</span>
              </div>
            </label>`).join('')}
        </div>
      </div>` : ''}
    </div>
    <div class="fixed bottom-0 left-0 w-full bg-m3-surface/80 backdrop-blur-md p-6 z-30">
      <div class="max-w-lg mx-auto">
        <button onclick="addFromModal('${p.id}')" class="w-full bg-m3-on-surface text-m3-surface rounded-full py-5 px-6 flex items-center justify-between shadow-m3-elevation-3">
          <div class="flex flex-col text-left"><span class="text-[11px] font-medium text-m3-surface/70 uppercase">AÃ±adir</span><span id="detail-total" class="text-xl font-extrabold">$${p.price.toFixed(2)}</span></div>
          <span class="material-icons-round text-2xl">shopping_cart</span>
        </button>
      </div>
    </div>`;
  document.body.style.overflow = 'hidden';
}

window.updateDetailPrice = function(productId, extra) {
  const p = allProducts.find(x => x.id === productId);
  if (p) document.getElementById('detail-total').textContent = `$${(p.price + extra).toFixed(2)}`;
};

function closeProductModal() {
  const modal = document.getElementById('product-modal');
  modal.classList.add('slide-down-full');
  setTimeout(() => { modal.classList.add('hidden'); document.body.style.overflow = ''; }, 300);
}

function addFromModal(productId) {
  const p = allProducts.find(x => x.id === productId);
  if (!p) return;
  let selectedOption = null;
  const radios = document.getElementsByName('product-option');
  if (p.options && p.options.length > 0) {
    for (const r of radios) { if (r.checked) { selectedOption = p.options.find(o => o.name === r.value); break; } }
  }
  addToCart(productId, selectedOption);
  closeProductModal();
}

function addToCart(productId, option = null) {
  const p = allProducts.find(x => x.id === productId);
  if (!p) return;
  const optionName = option ? option.name : null;
  const extraPrice = option ? (option.extraPrice || 0) : 0;
  const existingIndex = cart.findIndex(c => c.id === productId && c.optionName === optionName);
  if (existingIndex > -1) { cart[existingIndex].qty++; } else { cart.push({ id: productId, qty: 1, optionName: optionName, optionPrice: extraPrice }); }
  saveCart(); updateCartUI(); showToast(`AÃ±adido al carrito`);
}

function removeFromCart(index) { cart.splice(index, 1); saveCart(); updateCartUI(); renderCartContent(); }
function updateCartQty(index, delta) { 
  cart[index].qty += delta; 
  if (cart[index].qty <= 0) { removeFromCart(index); } else { saveCart(); updateCartUI(); renderCartContent(); }
}
function saveCart() { localStorage.setItem('fleur-cart', JSON.stringify(cart)); }
function updateCartUI() {
  const total = cart.reduce((s, c) => s + c.qty, 0);
  const badgeNav = document.getElementById('cart-badge-nav');
  if (total > 0) { badgeNav.classList.remove('hidden'); badgeNav.textContent = total; } else { badgeNav.classList.add('hidden'); }
}

function showCart() { renderCartContent(); document.getElementById('cart-modal').classList.remove('hidden'); document.getElementById('cart-modal').classList.add('slide-up-full'); }
function closeCart() { document.getElementById('cart-modal').classList.add('hidden'); }

function renderCartContent() {
  const container = document.getElementById('cart-content');
  if (cart.length === 0) { container.innerHTML = '<div class="text-center pt-20">Carrito vacÃ­o</div>'; return; }
  let subtotal = 0;
  const shipping = 15;
  let itemsHtml = cart.map((c, index) => {
    const p = allProducts.find(x => x.id === c.id);
    const itemPrice = (p.price + (c.optionPrice || 0)) * c.qty;
    subtotal += itemPrice;
    return `
    <div class="bg-m3-surface-container rounded-[24px] p-3 flex gap-4 items-center mb-3">
      <img src="${p.images?.[0] || p.image}" class="w-20 h-20 rounded-[16px] object-cover"/>
      <div class="flex-1">
        <h3 class="font-bold text-sm">${p.name}</h3>
        ${c.optionName ? `<p class="text-[10px] text-m3-outline">${c.optionName}</p>` : ''}
        <p class="font-extrabold text-m3-primary">$${itemPrice.toFixed(2)}</p>
        <div class="flex items-center gap-3 mt-2">
          <button onclick="updateCartQty(${index}, -1)" class="w-6 h-6 bg-m3-surface-variant rounded-full">-</button>
          <span class="text-xs font-bold">${c.qty}</span>
          <button onclick="updateCartQty(${index}, 1)" class="w-6 h-6 bg-m3-surface-variant rounded-full">+</button>
        </div>
      </div>
    </div>`;
  }).join('');
  
  container.innerHTML = `
    ${itemsHtml}
    <div class="mt-6 p-5 bg-m3-surface-container-low rounded-[24px]">
      <input id="cart-recipient" class="w-full bg-white border-none rounded-xl p-3 text-sm mb-3" placeholder="Para quiÃ©n..."/>
      <input id="cart-address" class="w-full bg-white border-none rounded-xl p-3 text-sm mb-3" placeholder="DirecciÃ³n en Charlotte..."/>
      <textarea id="cart-message" class="w-full bg-white border-none rounded-xl p-3 text-sm" placeholder="Mensaje..."></textarea>
    </div>
    <div class="mt-6 p-2">
      <div class="flex justify-between text-sm"><span>Subtotal</span><span>$${subtotal.toFixed(2)}</span></div>
      <div class="flex justify-between text-sm"><span>EnvÃ­o</span><span>$${shipping.toFixed(2)}</span></div>
      <div class="flex justify-between text-xl font-bold mt-2"><span>Total</span><span>$${(subtotal + shipping).toFixed(2)}</span></div>
    </div>
    <div class="fixed bottom-0 left-0 w-full p-4 bg-m3-surface">
      <button id="btn-checkout" onclick="processOrder()" class="w-full bg-[#128C7E] text-white py-4 rounded-full font-bold shadow-lg">Confirmar WhatsApp</button>
    </div>`;
}

async function processOrder() {
  const recipient = document.getElementById('cart-recipient').value.trim();
  const address = document.getElementById('cart-address').value.trim();
  const message = document.getElementById('cart-message').value.trim();

  if (!recipient || !address) { showToast('Faltan datos de entrega'); return; }

  const checkoutBtn = document.getElementById('btn-checkout');
  checkoutBtn.disabled = true;
  checkoutBtn.textContent = "Procesando...";

  try {
    let subtotal = 0;
    const itemsData = cart.map(c => {
      const p = allProducts.find(x => x.id === c.id);
      const unitPrice = p.price + (c.optionPrice || 0);
      const totalItem = unitPrice * c.qty;
      subtotal += totalItem;
      return { 
        product_id: c.id, 
        product_name: p.name, 
        quantity: c.qty, 
        option_name: c.optionName, 
        unit_price: unitPrice, 
        total_price: totalItem 
      };
    });

    const shipping = 15;
    const totalAmount = subtotal + shipping;

    // Payload para Supabase
    const orderPayload = {
      customer_name: recipient,
      customer_address: address,
      customer_message: message,
      items: itemsData,
      total_amount: totalAmount,
      shipping_cost: shipping,
      status: 'pendiente'
    };

    // Si el usuario estÃ¡ logueado, aÃ±adimos su ID al pedido
    if (currentUser) {
      orderPayload.user_id = currentUser.id;
    }

    const { error } = await supabase.from('orders').insert([orderPayload]);

    if (error) throw error;

    let waText = `Â¡Hola Fleur d'Amour! ðŸŒ¸\n\nHe realizado un nuevo pedido${currentUser ? ' (Soy cliente registrado)' : ''}:\n`;
    itemsData.forEach(i => {
      waText += `- ${i.quantity}x ${i.product_name} ${i.option_name ? `(${i.option_name})` : ''}: $${i.total_price.toFixed(2)}\n`;
    });
    waText += `\n*Total (con envÃ­o): $${totalAmount.toFixed(2)}*\n\n`;
    waText += `*Entregar a:* ${recipient}\n`;
    waText += `*DirecciÃ³n:* ${address}\n`;
    if (message) waText += `*Nota:* ${message}`;

    localStorage.removeItem('fleur-cart');
    cart = [];
    updateCartUI();
    window.location.href = `https://wa.me/${PHONE_NUMBER}?text=${encodeURIComponent(waText)}`;

  } catch (e) {
    console.error(e);
    showToast('Error al procesar pedido: ' + e.message);
    checkoutBtn.disabled = false;
    checkoutBtn.textContent = "Confirmar WhatsApp";
  }
}

function navigateTo(page) {
  // Update UI Pills
  document.querySelectorAll('.nav-btn').forEach(btn => {
    const pill = btn.querySelector('.nav-pill');
    if (btn.dataset.target === page) {
      pill.classList.add('bg-m3-primary-container', 'text-m3-on-primary-container');
      pill.classList.remove('text-m3-on-surface-variant');
    } else if (btn.dataset.target !== 'cart') { 
      pill.classList.remove('bg-m3-primary-container', 'text-m3-on-primary-container');
      pill.classList.add('text-m3-on-surface-variant');
    }
  });

  // View Logic
  const homeView = document.getElementById('home-view');
  const profileView = document.getElementById('profile-view');

  if (page === 'home') {
    activeCategory = 'all';
    document.getElementById('search-input').value = '';
    document.getElementById('section-title').textContent = 'Para ti';
    renderCategories();
    renderProducts();
    
    homeView.classList.remove('hidden');
    profileView.classList.add('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
  } else if (page === 'browse') {
    // Force switch to home view first if on profile
    homeView.classList.remove('hidden');
    profileView.classList.add('hidden');
    
    document.getElementById('search-input').focus();
    window.scrollTo({ top: 0, behavior: 'smooth' });

  } else if (page === 'profile') {
    homeView.classList.add('hidden');
    profileView.classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

function filterByCategory(id) { activeCategory = id; renderCategories(); renderProducts(); }
function filterProducts() { renderProducts(); }
function showToast(m) { 
  const t = document.createElement('div'); 
  t.className = "fixed bottom-24 left-1/2 -translate-x-1/2 bg-black text-white px-4 py-2 rounded-full text-sm z-[100]";
  t.textContent = m; document.body.appendChild(t); setTimeout(() => t.remove(), 2000);
}

loadData();
</script>
</body>
</html>
